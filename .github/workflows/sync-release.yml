# å·¥ä½œæµçš„åç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢
name: Sync Release to Customer Branches

on:
  #    è¯·æ³¨æ„ï¼šGitHub Actions çš„ cron ä½¿ç”¨ UTC æ—¶é—´ï¼Œ'0 2 * * 5' å¯¹åº”çš„æ˜¯åŒ—äº¬æ—¶é—´å‘¨äº”ä¸Šåˆ 10 ç‚¹ã€‚
  schedule:
    - cron: '0 2 * * 5'

  workflow_dispatch:

jobs:
  sync-branches:
    name: 'Sync release/1.x -> ${{ matrix.customer_branch }}'
    runs-on: ubuntu-latest

    # ä½¿ç”¨â€œçŸ©é˜µç­–ç•¥ (Matrix Strategy)â€æ¥ä¸ºå¤šä¸ªå®¢æˆ·åˆ†æ”¯å¹¶è¡Œæˆ–ä¸²è¡Œæ‰§è¡Œç›¸åŒçš„æ­¥éª¤
    # è¿™æ˜¯å¤„ç†å¤šä¸ªç›¸ä¼¼ä»»åŠ¡çš„æœ€ä½³å®è·µï¼Œæ— éœ€å¤åˆ¶ç²˜è´´ä»£ç 
    strategy:
      # è®¾ç½®ä¸º true æ—¶ï¼Œä¸€ä¸ªåˆ†æ”¯çš„å¤±è´¥ä¸ä¼šå–æ¶ˆå…¶ä»–åˆ†æ”¯çš„è¿è¡Œ
      fail-fast: false
      matrix:
        # åœ¨è¿™é‡Œåˆ—å‡ºä½ æ‰€æœ‰çš„å®¢æˆ·åˆ†æ”¯åç§°
        customer_branch:
          - 'customer/hkinfo-1.x'

    # ä»»åŠ¡çš„å…·ä½“æ‰§è¡Œæ­¥éª¤
    steps:
      # fetch-depth: 0 è¡¨ç¤ºè·å–æ‰€æœ‰çš„å†å²è®°å½•ï¼Œè¿™å¯¹äºåˆå¹¶æ“ä½œæ˜¯å¿…éœ€çš„
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤ 2ï¼šæ ¸å¿ƒé€»è¾‘ - å°è¯•åˆå¹¶åˆ†æ”¯å¹¶åˆ›å»º PR
      - name: Merge release/1.x & Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          # Git æäº¤è€…çš„ä¿¡æ¯
          commit-message: 'chore(sync): Merge branch release/1.x'
          committer: 'GitHub Actions <actions@github.com>'
          author: 'GitHub Actions <actions@github.com>'

          # PR çš„æ ‡é¢˜
          title: 'ğŸ”„ [Auto Sync] Merge `release/1.x` into `${{ matrix.customer_branch }}`'
          # PR çš„å†…å®¹
          body: |
            This is an automated PR to sync the latest changes from the `release/1.x` LTS branch.

            - **Source Branch:** `release/1.x`
            - **Target Branch:** `${{ matrix.customer_branch }}`

            Please review the changes and merge if everything is correct.
            If there are merge conflicts, this PR will not be created, and a notification will be sent.

          # åŸºç¡€åˆ†æ”¯ï¼Œå³ PR çš„ç›®æ ‡åˆ†æ”¯
          base: ${{ matrix.customer_branch }}
          # è¦åˆå¹¶è¿‡æ¥çš„æºåˆ†æ”¯
          # å®ƒä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶åˆ†æ”¯æ¥å­˜æ”¾åˆå¹¶åçš„ä»£ç 
          branch: 'actions/sync-release-to-${{ matrix.customer_branch }}'

          # å¦‚æœåˆ†æ”¯å·²æ˜¯æœ€æ–°ï¼Œåˆ™ä¸åˆ›å»º PR
          branch-suffix: 'timestamp'

      # æ­¥éª¤ 3ï¼šå¤„ç†åˆå¹¶å†²çªå’Œå¤±è´¥
      # è¿™ä¸ªæ­¥éª¤åªæœ‰åœ¨å‰é¢çš„æ­¥éª¤ï¼ˆç‰¹åˆ«æ˜¯åˆ›å»º PR çš„æ­¥éª¤ï¼‰å¤±è´¥æ—¶æ‰ä¼šè¿è¡Œ
      - name: Notify on Merge Conflict
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        with:
          # è¿™é‡Œä½¿ç”¨äº† Slack é€šçŸ¥ï¼Œä½ ä¹Ÿå¯ä»¥æ¢æˆ Teamsã€é’‰é’‰æˆ–é‚®ä»¶
          # SLACK_WEBHOOK_URL éœ€è¦é¢„å…ˆåœ¨ä»“åº“çš„ Secrets ä¸­é…ç½®å¥½
          status: 'failure'
          text: 'Merge conflict detected!'
          title: 'âŒ Merge Conflict: `release/1.x` -> `${{ matrix.customer_branch }}`'
          message: |
            The automated workflow failed to merge the `release/1.x` branch into `${{ matrix.customer_branch }}` due to merge conflicts.
            Please resolve the conflicts manually.
            Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 'danger'
          # ä½¿ç”¨ env ä¸Šä¸‹æ–‡æ¥å¼•ç”¨ Secrets
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}